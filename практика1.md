# Запуск Postgres в контейнере

```bash
mkdir -p $HOME/pg-for-go-devs/data

docker run \
    --rm \
    -d \
    -p 5432:5432 \
    --name postgres \
    -e POSTGRES_PASSWORD=P@ssw0rd \
    -e PGDATA=/var/lib/postgresql/data \
    -v $HOME/pg-for-go-devs/data:/var/lib/postgresql/data \
    --user $(id -u):$(id -g) \
    postgres:13.4
```

# Остановка Postgres контейнера

```bash
docker stop postgres
```

# Выполнение команд внутри контейнера

```bash
docker exec \
    -it \
    --user postgres \
    postgres \
    bash
```

# Подключение к БД с помощью psql

```bash
psql -h localhost -p 5432 -U postgres
```

# PSQL: метакоманды

```bash
# Вывести список БД
\l
# Подключиться к БД postgres
\c postgres
# Вывести список таблиц в БД
\d
# Вывести список локальных переменных
\set
# Закрыть psql
\q
```

# Создание пользователя

```sql
CREATE USER gopher
WITH PASSWORD 'P@ssw0rd';
```

# pg_hba.conf

Забекапим файл конфигурации, закоментируем все строки и добавим:

```bash
local   all             all                                     reject
```
Затем выполним:

```sql
SELECT pg_reload_conf();
```

Попытаемся подключиться из контейнера. Что наблюдаем? Что надо сделать чтобы разрешить подключения из контейнера? Что надо сделать, чтобы разрешить подключения с хоста?

Что в таблице `pg_authid`? Что такое md5 режим? Почему его не стоит использовать? Что такое `scram-sha-256` (https://www.postgresql.org/docs/11/auth-password.html)? Другие режимы (https://www.postgresql.org/docs/9.1/auth-pg-hba-conf.html)

# CREATE TYPE

Давайте создадим тип Semver:

```sql
CREATE OR REPLACE TYPE semver AS (
    Major integer,
    Minor integer,
    Patch integer
);

CREATE OR REPLACE FUNCTION semver(t text) RETURNS semver AS $$
    DECLARE
        t_parts text[];
    BEGIN
        t_parts = regexp_split_to_array(t, E'\\.');
        RETURN (t_parts[1]::integer, t_parts[2]::integer, t_parts[3]::integer);
    END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE CAST (text AS semver) WITH FUNCTION semver(t text);
```

# Создание БД курса

Для начала давайте создадим отдельную БД и схему для пользователя `gopher`.

```sql
CREATE DATABASE gopher_corp
    TEMPLATE = 'template0'
    ENCODING = 'utf-8'
    LC_COLLATE = 'C.UTF-8'
    LC_CTYPE = 'C.UTF-8';
```

Поучему это не сработало?

Попробуем снова:

```sql
CREATE DATABASE gopher_corp
    TEMPLATE = 'template0'
    ENCODING = 'utf-8'
    LC_COLLATE = 'C.UTF-8'
    LC_CTYPE = 'C.UTF-8';
```

Давайте попробуем подключиться к базе используя пользователя `gopher`:

```bash
psql --host 127.0.0.1 --port 5432 --username gopher --dbname gopher_corp
```

Что произойдет? А что должно было произойти? Почему все пошло не так?


Попробуем снова:

Выполним через пользователя `postgres`:

```sql
REVOKE ALL ON DATABASE gopher_corp FROM PUBLIC;
```

Попробуем подключиться пользователем `gopher`

Выполним через пользователя `postgres`:

```sql
ALTER DATABASE gopher_corp OWNER TO gopher;
```

Попробуем подключиться пользователем `gopher`.

Давайте создадим отношения в БД:

```sql
DROP TABLE IF EXISTS departments CASCADE;

CREATE TABLE departments (
    id INT GENERATED ALWAYS AS IDENTITY,
    parent_id INT REFERENCES departments (id),
    name VARCHAR(200),
    PRIMARY KEY(id)
);

DROP TABLE IF EXISTS positions CASCADE;
CREATE TABLE positions(
    id INT GENERATED ALWAYS AS IDENTITY,
    title VARCHAR(200),
    PRIMARY KEY (id)
);

DROP TABLE IF EXISTS employees CASCADE;
CREATE TABLE employees(
    id INT GENERATED ALWAYS AS IDENTITY,
    first_name VARCHAR(200),
    last_name VARCHAR(200),
    salary MONEY,
    manager_id INT REFERENCES employees(id),
    department_id INT REFERENCES departments(id),
    position INT REFERENCES positions(id),
    PRIMARY KEY(id)
);
```

Добавим в таблицы какие-нибудь данные:

```sql
INSERT INTO departments(parent_id, name)
VALUES
    (NULL, 'root');
    
INSERT INTO departments (parent_id, name)
    SELECT id, 'R&D'
    FROM departments
    WHERE name = 'root'; 

INSERT INTO employees (first_name, last_name, salary, manager_id, department_id, position)
VALUES
    ('Jane', 'Doe', 75000.00, NULL, 2, 2),
    ('John', 'Doe', 50000.00, NULL, 2, 1);

INSERT INTO positions(title)
VALUES
    ('Software Engineer II'),
    ('Software Engineer III');
```